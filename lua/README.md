**homebridge-mculed** ESP8266 LUA Code

LUA programs for a nodeMCU device to control a RGB+W LED Strip

<!--ts-->
* [Hardware - CLED](#hardware---cled)
* [Circuit Diagrams - CLED](#circuit-diagrams---cled)
   * [Schematic](#schematic)
   * [Breadboard layout](#breadboard-layout)
   * [Actual Breadboard layout](#actual-breadboard-layout)
   * [Unit 1 - layout](#unit-1---layout)
   * [Unit 1 - Completed unit](#unit-1---completed-unit)
   * [Unit 2 - Completed unit](#unit-2---completed-unit)
* [Tools](#tools)
* [Hardware - RGBLED](#hardware---rgbled)
* [Circuit Diagrams - RGBLED](#circuit-diagrams---rgbled)
   * [Schematic](#schematic-1)
   * [Stripboard layout](#stripboard-layout)
   * [Unit 1 - layout](#unit-1---layout-1)
   * [XMAS 2019 Final](#xmas-2019-final)
      * [LED Control Module](#led-control-module)
      * [Controller](#controller)
* [Installation](#installation)
   * [OTA Server Prequisites](#ota-server-prequisites)
      * [Install lua and Lua modules](#install-lua-and-lua-modules)
   * [nodeMCU Firmware](#nodemcu-firmware)
   * [Configuration](#configuration)
   * [Provisioning and Running](#provisioning-and-running)
* [ESPlorer Snippets](#esplorer-snippets)
   * [Memory](#memory)

<!-- Created by https://github.com/ekalinin/github-markdown-toc -->
<!-- Added by: runner, at: Fri Dec  6 15:00:35 UTC 2024 -->

<!--te-->

# Hardware - CLED

1.  Bill of materials
    -   nodeMCU / esp8266 dev kit
    -   ~~Level Shifter~~ - I received inconsistent behavior when using this and switch to 74HCT245
    -   74HCT245 - Level Shifter replacement
    -   1000uf 25V capacitor
    -   470 Ohm Resistor
    -   DC to DC Power Converter
    -   ~~78M05 Voltage Regulator~~ - I tried using the voltage regulator, but did not take into account the heat generated by lowering the voltage
    -   2 x Push Button switch
    -   FQP30N06L N-Channel MOSFET
    -   Case - Hammond 1593NBK

# Circuit Diagrams - CLED

## Schematic
![CLED](diagrams/mculed_v2_perf_schem.jpg)
## Breadboard layout
![CLED](diagrams/mculed_v2_perf_bb.jpg)
## Actual Breadboard layout
![Breadboard](diagrams/IMG_2846-2.JPG)
## Unit 1 - layout
![Perfboard](diagrams/IMG_2857.jpg)
## Unit 1 - Completed unit
![Perfboard](diagrams/IMG_2862.jpg)
## Unit 2 - Completed unit
![Perfboard](diagrams/IMG_2890.JPG)
# Tools

-   nodeMCU-uploader - Install instructions are here <https://github.com/kmpm/nodeMCU-uploader>
-   lua - Install instructions are here <https://www.lua.org/download.html>
-   esptool - Install instructions are here <https://github.com/espressif/esptool>
-   esplorer - Install instructions are here <https://esp8266.ru/esplorer/>

# Hardware - RGBLED

1.  Bill of materials
    -   50pcs DC5V 12mm WS2811 IC RGB Led Module Christmas String Green wire Waterproof IP68
    -   nodeMCU / esp8266 dev kit
    -   74HCT245 - Level Shifter replacement
    -   1000uf 25V capacitor
    -   2 x 470 Ohm Resistor
    -   5 VDC 3 Amp Power Supply
    -   2.1 MM DC Chassis Mount
    -   Case - Hammond 1593NBK

# Circuit Diagrams - RGBLED

## Schematic
![RGBLED](diagrams/mculed_v3_strip_schem.jpg)
## Stripboard layout
![RGBLED](diagrams/mculed_v3_strip_bb.jpg)
## Unit 1 - layout
![Unit 1](diagrams/IMG_4175.JPG)

## XMAS 2019 Final ##

### LED Control Module ###

For the final version for XMAS 2019, I switched to the [ESPPixelStick](https://github.com/forkineye/ESPixelStick) firmware rather than roll my own code.  While this worked really well, it did have an issue when rebooting and getting stuck in AP mode, also the ESP website was problematic.  Next year am thinking to reflash with WLED.

For hooking up the strips, I changed the plan at the last minute and ended up connecting both strips end to end.  And then looping back to the esp8266 for power injection at the end of the strip.

### Controller ###

To control the lights, I used [Falcon Player](https://github.com/FalconChristmas/fpp) running on a RPI, and to design the sequence I used xlights running from Bart.

# Installation

## OTA Server Prequisites

### Install lua and Lua modules

```
brew install lua
brew install luarocks
luarocks install luasocket
luarocks install luafilesystem
luarocks install md5
luarocks install lua-cjson 2.1.0-1
```

## nodeMCU Firmware

1.  Using <http://nodeMCU-build.com>, create a custom firmware containing at least
    these modules:

    `bit,color_utils,crypto,file,gpio,mdns,net,node,pwm,sjson,tmr,uart,websocket,wifi,ws2812,ws2812_effects`


2.  Please use esptool to install the float firmware onto your nodeMCU.  There are alot of guides for this, so I won't repeat it here.


3.  Run the script lua/src/initialUpload.sh, this will upload all the lua ota provisioning files to your esp8266

4.  Start esplorer, connect to the nodeMCU and run the following commands to get the device name

```
=wifi.sta.clearconfig()
=wifi.setmode(wifi.STATION,false)
=wifi.sta.gethostname()
```

This should return the nodeMCU name, i.e. NODE-AC4957

## Configuration

1.  WIFI Setup - Copy luaOTA/passwords_sample.lua to luaOTA/passwords.lua and add your wifi SSID and passwords.  Please note
    that the configuration supports multiple wifi networks, one per config line.


    module.SSID["SSID1"] = { ssid="SSID1", pwd = "password" }

2.  Copy config-NODE-AC545F.lua to your nodeMCU's name, and change the config to your model

```
    module.Model = "CLED"
```
or
```
    module.Model = "RGBLED"
```

3.  Copy ESP-NODE-AC545f.json to your nodeMCU's name, and update the file to include your config file.

## Provisioning and Running

1.  Start the OTA server with the script, startOtaServer.sh

2.  Using esplorer, on the nodeMCU, run the lua program initOta.lua

3.  After running, the nodeMCU will reboot a couple of times then the device should start running.

# ESPlorer Snippets

## Memory

```
    print("\n------- GLOBALS --------\n")

    for k,v in pairs(_G) do print(k,v) end

    print("\n-------- REGISTRY -------\n")

    for k,v in pairs(debug.getregistry()) do print(k,v) end

    print("\n------- PACKAGES --------\n")

    table.foreach (package.loaded, print)
```
